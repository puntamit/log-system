<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Log ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h2 class="text-2xl font-bold mb-4 text-center text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Log ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h2>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° -->
    <form id="logForm" class="grid grid-cols-2 gap-4 mb-6">
      <div class="col-span-2">
        <label class="block mb-1 font-medium">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
        <div class="flex gap-2">
          <select id="issue" class="flex-1 border p-2 rounded"></select>
          <button type="button" onclick="addDropdown('issue')" class="bg-green-500 text-white px-3 rounded">+</button>
        </div>
      </div>

      <div>
        <label class="block mb-1 font-medium">Tag (‡πÄ‡∏•‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)</label>
        <input id="tag" class="w-full border p-2 rounded" />
      </div>

      <div>
        <label class="block mb-1 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
        <input id="location" class="w-full border p-2 rounded" />
      </div>

      <div>
        <label class="block mb-1 font-medium">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</label>
        <div class="flex gap-2">
          <select id="reporter" class="flex-1 border p-2 rounded"></select>
          <button type="button" onclick="addDropdown('reporter')" class="bg-green-500 text-white px-3 rounded">+</button>
        </div>
      </div>

      <div>
        <label class="block mb-1 font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <input id="note" class="w-full border p-2 rounded" />
      </div>

      <button type="submit" class="col-span-2 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </form>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th class="px-4 py-2 border">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th>
            <th class="px-4 py-2 border">Tag</th>
            <th class="px-4 py-2 border">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="px-4 py-2 border">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
            <th class="px-4 py-2 border">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th class="px-4 py-2 border text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>

    <p id="status" class="text-center mt-3 text-sm"></p>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxiwo-LvzcsXfF0_fZwKyFjoBhfWwnBVddpBUb9A91BuD_uZSLRWXWTIBeM30ryH51x/exec";
    const status = document.getElementById("status");
    const tableBody = document.getElementById("logTable");

    window.addEventListener("DOMContentLoaded", () => {
      loadDropdowns();
      loadData();
    });

    async function loadDropdowns() {
      const res = await fetch(`${scriptURL}?action=getDropdowns`);
      const json = await res.json();
      fillSelect("issue", json.issues);
      fillSelect("reporter", json.reporters);
    }

    function fillSelect(id, items) {
      const select = document.getElementById(id);
      select.innerHTML = `<option disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>` +
        items.map(i => `<option value="${i}">${i}</option>`).join("");
    }

    async function loadData() {
      tableBody.innerHTML = "<tr><td colspan='7' class='text-center py-4'>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
      const res = await fetch(`${scriptURL}?action=getData`);
      const json = await res.json();
      renderTable(json);
    }

    function renderTable(data) {
      if (!data || !data.length) {
        tableBody.innerHTML = "<tr><td colspan='7' class='text-center py-4'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
        return;
      }
      tableBody.innerHTML = data.map((r, i) => `
        <tr class="border-b">
          <td class="px-3 py-1">${r.timestamp}</td>
          <td class="px-3 py-1">${r.issue}</td>
          <td class="px-3 py-1">${r.tag}</td>
          <td class="px-3 py-1">${r.location}</td>
          <td class="px-3 py-1">${r.reporter}</td>
          <td class="px-3 py-1">${r.note}</td>
          <td class="px-3 py-1 text-center">
            <button onclick="deleteRow(${i+1})" class="text-red-600 hover:underline">‡∏•‡∏ö</button>
          </td>
        </tr>
      `).join("");
    }

    async function deleteRow(index) {
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
      const res = await fetch(`${scriptURL}?action=delete&index=${index}`);
      const json = await res.json();
      if (json.result === "success") {
        status.textContent = "üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
        loadData();
      }
    }

    document.getElementById("logForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        issue: issue.value,
        tag: tag.value,
        location: location.value,
        reporter: reporter.value,
        note: note.value
      };
      const res = await fetch(`${scriptURL}?action=add&payload=${encodeURIComponent(JSON.stringify(data))}`);
      const json = await res.json();
      if (json.result === "success") {
        status.textContent = "‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
        e.target.reset();
        loadData();
        loadDropdowns();
      }
    });

    async function addDropdown(type) {
      const value = prompt("‡πÄ‡∏û‡∏¥‡πà‡∏° " + (type === "issue" ? "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö" : "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á") + ":");
      if (!value) return;
      const res = await fetch(`${scriptURL}?action=addDropdown&type=${type}&value=${encodeURIComponent(value)}`);
      const json = await res.json();
      if (json.result === "success") {
        status.textContent = "‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß";
        loadDropdowns();
      } else {
        status.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ";
      }
    }
  </script>
</body>
</html>
